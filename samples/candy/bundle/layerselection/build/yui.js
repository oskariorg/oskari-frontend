/* This is a packed Oskari bundle (bundle script version Mon Feb 27 2012 09:28:33 GMT+0200 (Suomen normaaliaika)) */ 
Oskari.clazz.define("Oskari.mapframework.ui.module.layerselector.SelectedLayersModule",function(a){this._core;this._sandbox;this._publisherWizardStepNumber=a;this._layerPortal=null;this._layerOrder=null;this._items={layerItems:{}};this.loc={};this._scale=null},{getName:function(){return"SelectedLayersModule"},isPublisherWizardStep:function(a){if(this._publisherWizardStepNumber==a){return true}else{return false}},init:function(b){this._sandbox=b;b.printDebug("Initializing selected layers module...");for(p in this.eventHandlers){b.registerForEventByName(this,p)}this.createLocale();var a=this.createUI();this.updateCurrentState();return a},start:function(a){a.printDebug("Starting "+this.getName())},stop:function(a){},createLocale:function(){var a=this._sandbox;this.loc={leftpanel_selected_layers_title:a.getText("leftpanel_selected_layers_title"),leftpanel_style:a.getText("leftpanel_style"),mapservice_select_layer_style:a.getText("mapservice_select_layer_style"),mapservice_basemap_image_tooltip:a.getText("mapservice_basemap_image_tooltip"),mapservice_layer_delete_title:a.getText("mapservice_layer_delete_title"),mapservice_maplayer_image_tooltip:a.getText("mapservice_maplayer_image_tooltip"),mapservice_layer_show_info_title:a.getText("mapservice_layer_show_info_title"),selected_layers_module_published_basemaps_title:a.getText("selected_layers_module_published_basemaps_title"),selected_layers_module_published_maps_title:a.getText("selected_layers_module_published_maps_title"),selected_layers_module_wfs_icon_tooltip:a.getText("selected_layers_module_wfs_icon_tooltip"),selected_layers_module_vector_icon_tooltip:a.getText("selected_layers_module_vector_icon_tooltip"),selected_layers_module_highlight_wms_layer:a.getText("selected_layers_module_highlight_wms_layer"),selected_layers_module_highlight_wfs_layer:a.getText("selected_layers_module_highlight_wfs_layer"),selected_layers_module_highlight_wfs_layer:a.getText("selected_layers_module_highlight_wfs_layer")}},updateCurrentState:function(){var b=this._sandbox;var e=this;var f=b.findAllSelectedMapLayers();for(var d=0;d<f.length;d++){var c=f[d];var a=c.getId();b.printDebug("preselecting "+a);e.addMapLayerToSelection(a,c,true)}},createUI:function(){var b=this._sandbox;var f=this;var d=f.loc.leftpanel_selected_layers_title;if(this.isPublisherWizardStep(1)){d=f.loc.selected_layers_module_published_basemaps_title}else{if(this.isPublisherWizardStep(2)){d=f.loc.selected_layers_module_published_maps_title}}var e=Ext.create("Ext.app.PortalColumn",{id:"selectedLayersTab",autoWidth:true,autoScroll:false});this._items.selectedLayersTab=e;var a=Ext.create("Ext.app.PortalPanel",{id:"groupPanel",title:d,autoScroll:true,items:[e]});this._layerPortal=a;a.on("drop",function(h){var g=h.panel._layerId;f.updateLayerOrder(g)});a.on("beforedrop",function(){f.buildLayerOrder()});a.on("validatedrop",function(g){g.status=g.panel._layerId?true:false});var c=Ext.create("Ext.tab.Panel",{id:"selectedLayersTabPanel",layout:"fit",anchor:"100%, 50%",frame:false,border:false,autoScroll:false,items:[a]});this._items.selectedLayerPanel=c;return c},buildLayerOrder:function(){var b={};var c=this;var a=c._layerPortal;var d=Ext.ComponentQuery.query("portlet",a);Ext.Array.each(d,function(h,g,e){var f=h._layerId;b[f]=g});this._layerOrder=b},updateLayerOrder:function(d){var g=this;var f=this._layerPortal;var k=this._layerOrder;var b=Ext.ComponentQuery.query("portlet",f);var h={};Ext.Array.each(b,function(o,m,l){var n=o._layerId;h[n]=m});for(p in h){var a=p;if(d!=a){continue}var e=h[a];var j=k[a];if(j==e){continue}var i=b.length-e-1;var c=g._sandbox.getRequestBuilder("RearrangeSelectedMapLayerRequest")(d,i);g._sandbox.request(g.getName(),c);break}},getNewSelectedLayersInsidePanel:function(b,h,d,a,e){var g=this;var c=null;var i=new Array();var f=Ext.create("Ext.Panel",{id:"leftpanel-selected-layers-controls_basic_"+a,layout:{type:"hbox",align:"stretch",pack:"start"},baseCls:"",border:true,defaults:{padding:"5 5 0 5",baseCls:"",border:true},items:[{items:b},{items:h,flex:1},{items:e}]});i.push(f);if(d!=null){var j=Ext.create("Ext.Panel",{id:"leftpanel-selected-layers-controls_style_"+a,layout:{type:"hbox",align:"stretch",pack:"start"},baseCls:"",border:true,width:"100%",defaults:{padding:"0 5 0 5",baseCls:"",border:true},items:[{html:g.loc.leftpanel_style},{items:d,flex:1}]});
i.push(j)}c=Ext.create("Ext.Panel",{id:"leftpanel-selected-layers-controls_"+a,layout:{type:"vbox",align:"stretch",pack:"start"},cls:"leftpanel-selected-layers-controls",border:false,height:32*i.length,defaults:{padding:"0 5 0 5",flex:1},items:i});return c},getOpacityLabel:function(b,c){var a=Ext.create("Ext.form.Label",{text:b+"%"});return a},getOpacitySlider:function(c,g,d,a){var f=false;if(this.isPublisherWizardStep(1)||this.isPublisherWizardStep(2)){f=true}var b=this;var e=null;if(f==false){e={change:function(j,i){var h=b._sandbox;h.request("SelectedLayersModule",h.getRequestBuilder("ChangeMapLayerOpacityRequest")(g,this.getValue()));a.setText(this.getValue()+"%")}}}else{e={change:function(i,h){a.setText(this.getValue()+"%")},changecomplete:function(j,i){var h=b._sandbox;h.request("SelectedLayersModule",h.getRequestBuilder("ChangeMapLayerOpacityRequest")(g,this.getValue()))}}}return Ext.create("Ext.slider.Single",{width:100,minValue:0,maxValue:100,animate:true,value:c,listeners:e})},getNewSelectedLayersPanel:function(d,k){var a=d.getName();var b=d.getId();var j=d.isBaseLayer();var h=null;var g=this;var e=[];var i=null;if(j){i="layer_type_stack"}else{if(d.isGroupLayer&&d.isGroupLayer()){i="layer_type_group"}else{if(d.isLayerOfType("WMS")){e.push({baseCls:"custom-tool",type:"gear",tooltip:g.loc.mapservice_layer_show_info_title,handler:function(){g._sandbox.requestByName("SelectedLayersModule","ShowMapLayerInfoRequest",[b])}})}if(d.isLayerOfType("WMS")){i="layer_type_wms"}else{if(d.isLayerOfType("WFS")){i="layer_type_wfs"}else{if(d.isLayerOfType("VECTOR")){i="layer_type_vector"}else{i="layer_type_wms"}}}}}if(d.getDataUrl()){e.push({type:"search",baseCls:"custom-tool",qtip:g.loc.mapservice_layer_show_info_title,handler:function(){g._sandbox.requestByName("SelectedLayersModule","ShowOverlayPopupRequest",[d.getDataUrl()])}})}e.push({type:"close",baseCls:"custom-tool",tooltip:g.loc.mapservice_layer_delete_title,handler:function(){g._sandbox.requestByName("SelectedLayersModule","RemoveMapLayerRequest",[b])}});h=Ext.create("Ext.app.Portlet",{_layerId:b,collapsible:false,id:"selectedLayer-"+b,iconCls:i,scroll:false,tools:e,title:f(a),layout:"fit",items:k,frame:false,border:false,closable:false});function c(q){var m="12px arial",n=jQuery("<div>"+q+"</div>").css({position:"absolute","float":"left",visibility:"hidden",font:m}).appendTo(jQuery("body")),l=n.width();n.remove();return l}function f(o){if(!g._items.selectedLayerPanel.getVisibilityEl()){return o}var q=c(o);var n=o;var r=false;var m=110;var l=g._items.selectedLayerPanel.getWidth()-m;while(q>110&&q>l){r=true;n=n.substring(0,n.length-3);q=c(n)}if(r){n=n+"..."}return'<span data-qtip="'+o+'" style="width: 40px;overflow: hidden;">'+n+"</span>"}return h},getStyleCombo:function(b,e,f){var a=this._sandbox;var d=this;var c=Ext.create("Ext.form.ComboBox",{id:"layer-style_"+f,ctCls:"mapservice-combostyle",store:b,mode:"local",triggerAction:"all",emptyText:d.loc.mapservice_select_layer_style,hideLabel:true,autoSelect:true,editable:false,width:"100%",listeners:{select:function(h,i){var k=i[0].index;var g=e[k];var j=f;a.request("SelectedLayersModule",a.getRequestBuilder("ChangeMapLayerStyleRequest")(j,g))}}});return c},afterMapLayerAddEvent:function(c){var b=c.getMapLayer();var a=b.getId();var d=c.getKeepLayersOrder();this.addMapLayerToSelection(a,b,d);this.checkLayerScales()},addMapLayerToSelection:function(h,v,c){var u=this;var o={};this._items.layerItems[h]=o;var q=null;var g=null;var m=null;if(v.isBaseLayer()){g=this.getOpacityLabel(v.getOpacity(),h);q=this.getOpacitySlider(v.getOpacity(),h,true,g)}else{g=this.getOpacityLabel(v.getOpacity(),h);q=this.getOpacitySlider(v.getOpacity(),h,false,g)}o.slider=q;o.label=g;var k=false;if(this.isPublisherWizardStep(1)||this.isPublisherWizardStep(2)){k=true}var s=null;if(v.isLayerOfType("WFS")||v.isLayerOfType("VECTOR")||v.isBaseLayer()||k){}else{if(!v.isBaseLayer()){var e=v.getStyles();var j=new Array();var t=new Array();for(var r=0;r<v.getStyles().length;r++){j.push(v.getStyles()[r].getTitle());t.push(v.getStyles()[r].getName())}if(t.length>1&&j.length>1){s=this.getStyleCombo(j,t,v.getId());
if(v.getCurrentStyle()!=null&&v.getCurrentStyle()!=""&&v.getCurrentStyle().getName()!=""){var d=t.indexOf(v.getCurrentStyle().getName());var f=j[d];s.setValue(f)}else{var d=0;var f=j[d];s.setValue(f)}}}}o.styleCombo=s;if(!v.isBaseLayer()&&!this.isPublisherWizardStep(1)){m=this.createHighlighButtonAndAttachHighlightHandlerForLayer(v)}o.buttonGetFeatures=m;var n=this.getNewSelectedLayersInsidePanel(q,g,s,v.getId(),m);o.chkPanel=n;var l=this.getNewSelectedLayersPanel(v,n);o.panel=l;var b=u._items.selectedLayersTab;if(b){if(v.isBaseLayer()){var a=b.items.length+1;if(c){b.insert(0,l)}else{b.insert(a,l)}}else{b.insert(0,l)}this._layerPortal.doLayout()}},createHighlighButtonAndAttachHighlightHandlerForLayer:function(c){var e=this;var b=e._sandbox;var d=c.getId();var a=null;var f=null;if(c.isLayerOfType("WMS")){a="wms-maplayer";f=e.loc.selected_layers_module_highlight_wms_layer}else{if(c.isLayerOfType("WFS")){a="wfs-maplayer";f=e.loc.selected_layers_module_highlight_wfs_layer}else{if(c.isLayerOfType("VECTOR")){a="wfs-maplayer";f=e.loc.selected_layers_module_highlight_wfs_layer}else{a="wms-maplayer";f=""}}}return Ext.create("Ext.Button",{iconCls:a,cls:"x-btn-icon",width:35,height:20,scale:"large",enableToggle:true,toggleGroup:"layerHighlightButtonGroup",tooltip:f,handler:function(){var g=b.isMapLayerHighLighted(d);if(g){b.request("SelectedLayersModule",b.getRequestBuilder("DimMapLayerRequest")(d))}else{b.request("SelectedLayersModule",b.getRequestBuilder("HighlightMapLayerRequest")(d))}}})},afterMapLayerRemoveEvent:function(b){var a=b.getMapLayer().getId();this.removeMapLayerFromSelection(a)},removeMapLayerFromSelection:function(a){var c=this._items.layerItems[a];var b=c.panel;c.panel=null;c.slider=null;c.label=null;c.buttonGetFeatures=null;b.destroy();this._items.layerItems[a]=null;this._layerPortal.doLayout()},checkLayerScales:function(){var b=this._scale=this._sandbox.getMap().getScale();var j=this._sandbox;var h=this._items.layerItems;var d=j.findAllSelectedMapLayers();for(var e=0;e<d.length;e++){var f=d[e];var c=f.getId();if(f.isBaseLayer()){continue}if(b>f.getMaxScale()&&b<f.getMinScale()){var g=h[c];var a=g.panel;if(a!=null){a.removeCls("layertree-scale-not-in-range")}}else{var g=h[c];var a=g.panel;if(a!=null){a.addCls("layertree-scale-not-in-range")}}}},afterChangeMapLayerOpacityEvent:function(e){var a=e.getMapLayer();var c=this._items.layerItems;var b=c[a.getId()];var d=b.slider;d.setValue(a.getOpacity())},afterChangeMapLayerStyleEvent:function(f){var a=f.getMapLayer();var e=this._items.layerItems;var c=e[a.getId()];var b=c.styleCombo;var d=f.getMapLayer().getCurrentStyle();if(b&&d){b.setValue(d)}},handleAfterHighlightMapLayerEvent:function(f){var c=f.getMapLayer();var a=this._sandbox;var e=this._items.layerItems;var d=e[c.getId()];var b=d.panel;b.addCls("higlighted");d.chkPanel.addCls("higlighted-panel-content")},handleAfterDimMapLayerEvent:function(f){var c=f.getMapLayer();var a=this._sandbox;var e=this._items.layerItems;var d=e[c.getId()];var b=d.panel;b.removeCls("higlighted");d.chkPanel.removeCls("higlighted-panel-content");if(d.buttonGetFeatures){d.buttonGetFeatures.toggle(false)}},eventHandlers:{AfterMapLayerAddEvent:function(a){this.afterMapLayerAddEvent(a)},AfterMapLayerRemoveEvent:function(a){this.afterMapLayerRemoveEvent(a)},AfterMapMoveEvent:function(a){this.checkLayerScales()},AfterChangeMapLayerOpacityEvent:function(a){if(this._sandbox.getObjectCreator(a)!=this.getName()){this.afterChangeMapLayerOpacityEvent(a)}},AfterChangeMapLayerStyleEvent:function(a){if(this._sandbox.getObjectCreator(a)!=this.getName()){this.afterChangeMapLayerStyleEvent(a)}},AfterHighlightMapLayerEvent:function(a){this.handleAfterHighlightMapLayerEvent(a)},AfterDimMapLayerEvent:function(a){this.handleAfterDimMapLayerEvent(a)},ToolSelectedEvent:function(b){var a=this._sandbox;var c=this._sandbox.findAllHighlightedLayers();if(c&&c.length>0){a.request("SelectedLayersModule",a.getRequestBuilder("DimMapLayerRequest")(c[0].getId()))}}},onEvent:function(b){var a=this.eventHandlers[b.getName()];if(!a){return}return a.apply(this,[b])}},{protocol:["Oskari.mapframework.module.Module"]});
Oskari.clazz.define("Oskari.mapframework.bundle.DefaultLayerSelectionBundleInstance",function(a){this.name="layerselection";this.mediator=null;this.sandbox=null;this.impl=null;this.ui=null},{createPanel:function(){var c=this;var a=c.libs.ext;var b=a.create("Ext.Panel",{region:"center",layout:"fit",height:512,border:false,items:[]});return b},start:function(){if(this.mediator.getState()=="started"){return}var b=this;b.libs={ext:Oskari.$("Ext")};b.facade=Oskari.$("UI.facade");b.impl=Oskari.clazz.create("Oskari.mapframework.ui.module.layerselector.SelectedLayersModule");var a=b.createPanel();var c=b.facade.appendExtensionModule(b.impl,b.name,{},b,"NW",{fi:{title:"Valitut karttatasot"},sv:{title:"?"},en:{title:"Map Layers"}},a);b.def=c;a.add(c.initialisedComponent);b.impl.start(b.facade.getSandbox());b.mediator.setState("started");return this},update:function(d,a,c,e){d.alert("RECEIVED update notification @BUNDLE_INSTANCE: "+e)},stop:function(){this.impl.stop();this.facade.removeExtensionModule(this.impl,this.name,this.impl.eventHandlers,this);this.impl=null;this.mediator.setState("stopped");return this},getName:function(){return this.__name},__name:"Oskari.mapframework.bundle.DefaultLayerSelectionBundleInstance"},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.bundle.extension.Extension"]});