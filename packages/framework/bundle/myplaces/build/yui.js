/* This is a packed Oskari bundle (bundle script version Thu May 31 2012 12:23:19 GMT+0300 (Suomen kesäaika)) */ 
Oskari.clazz.define("Oskari.mapframework.myplaces.event.FinishedDrawingEvent",function(a){this._creator=null;if(a){if(a.geometry){this._drawing=a.geometry}if(a.modification){this._modification=a.modification}}},{__name:"MyPlaces.FinishedDrawingEvent",getName:function(){return this.__name},getDrawing:function(){return this._drawing},isModification:function(){return this._modification}},{protocol:["Oskari.mapframework.event.Event"]});Oskari.clazz.define("Oskari.mapframework.myplaces.event.MyPlaceHoverEvent",function(b,a,c){this._creator=null;this._lonlat=b;this._hoverEvent=a;this._zoom=c},{__name:"MyPlaces.MyPlaceHoverEvent",getName:function(){return this.__name},getHoverEvent:function(){return this._hoverEvent},getLonLat:function(){return this._lonlat},getZoomLevel:function(){return this._zoom}},{protocol:["Oskari.mapframework.event.Event"]});Oskari.clazz.define("Oskari.mapframework.myplaces.event.MyPlacesChangedEvent",function(a){this._creator=null},{__name:"MyPlaces.MyPlacesChangedEvent",getName:function(){return this.__name}},{protocol:["Oskari.mapframework.event.Event"]});Oskari.clazz.define("Oskari.mapframework.myplaces.event.MyPlaceSelectedEvent",function(b,a){this._creator=null;this._myPlace=b;this._dblClick=a},{__name:"MyPlaces.MyPlaceSelectedEvent",getName:function(){return this.__name},getPlace:function(){return this._myPlace},isDblClick:function(){return this._dblClick}},{protocol:["Oskari.mapframework.event.Event"]});Ext.define("Oskari.mapframework.bundle.myplaces.model.MyPlace",{extend:"Ext.data.Model",fields:["id","name","description","categoryID","geometry","createDate","updateDate"]});Ext.define("Oskari.mapframework.bundle.myplaces.model.MyPlacesCategory",{extend:"Ext.data.Model",fields:["id","name","isDefault","lineWidth","lineColor","fillColor","dotSize","dotColor"]});Oskari.clazz.define("Oskari.mapframework.myplaces.mapmodule.DrawPlugin",function(){this.mapModule=null;this.pluginName=null;this._sandbox=null;this._map=null;this.drawControls=null;this.drawLayer=null;this.editMode=false;this.currentDrawMode=null},{__name:"MyPlaces.DrawPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(a){this.mapModule=a;this._map=a.getMap();this.pluginName=a.getName()+this.__name},startDrawing:function(b){if(b.isModify){this.modifyControls.modify.selectControl.select(this.drawLayer.features[0])}else{this.drawLayer.removeAllFeatures();if(b.geometry){this.editMode=true;var a=[new OpenLayers.Feature.Vector(b.geometry)];this.drawLayer.addFeatures(a);this.modifyControls.modify.selectControl.select(this.drawLayer.features[0])}else{this.editMode=false;this.toggleControl(b.drawMode)}}},stopDrawing:function(){this.toggleControl();this.drawLayer.removeAllFeatures()},forceFinishDraw:function(){try{this.drawControls[this.currentDrawMode].finishSketch()}catch(a){this.stopDrawing();var b=this._sandbox.getEventBuilder("MyPlaces.MyPlaceSelectedEvent")();this._sandbox.notifyAll(b)}},finishedDrawing:function(){this.toggleControl();var a=this.getDrawing();if(this.editMode){a.modification=this.editMode}else{this.modifyControls.modify.selectControl.select(this.drawLayer.features[0])}var b=this._sandbox.getEventBuilder("MyPlaces.FinishedDrawingEvent")(a);this._sandbox.notifyAll(b)},toggleControl:function(b){this.currentDrawMode=b;for(var a in this.drawControls){var c=this.drawControls[a];if(b==a){c.activate()}else{c.deactivate()}}},init:function(a){var c=this;this.requestHandlers={startDrawingHandler:Oskari.clazz.create("Oskari.mapframework.myplaces.request.StartDrawingRequestPluginHandler",a,c),stopDrawingHandler:Oskari.clazz.create("Oskari.mapframework.myplaces.request.StopDrawingRequestPluginHandler",a,c),getGeometryHandler:Oskari.clazz.create("Oskari.mapframework.myplaces.request.GetGeometryRequestPluginHandler",a,c)};this.drawLayer=new OpenLayers.Layer.Vector("MyPlaces Draw Layer",{eventListeners:{featuresadded:function(d){c.finishedDrawing()}}});this.drawControls={point:new OpenLayers.Control.DrawFeature(c.drawLayer,OpenLayers.Handler.Point),line:new OpenLayers.Control.DrawFeature(c.drawLayer,OpenLayers.Handler.Path),area:new OpenLayers.Control.DrawFeature(c.drawLayer,OpenLayers.Handler.Polygon)};
this.modifyControls={modify:new OpenLayers.Control.ModifyFeature(c.drawLayer)};this._map.addLayers([c.drawLayer]);for(var b in this.drawControls){this._map.addControl(this.drawControls[b])}for(var b in this.modifyControls){this._map.addControl(this.modifyControls[b])}this.modifyControls.modify.activate()},getDrawing:function(a){return{geometry:this.drawLayer.features[0].geometry}},register:function(){},unregister:function(){},startPlugin:function(a){this._sandbox=a;a.register(this);a.addRequestHandler("MyPlaces.StartDrawingRequest",this.requestHandlers.startDrawingHandler);a.addRequestHandler("MyPlaces.StopDrawingRequest",this.requestHandlers.stopDrawingHandler);a.addRequestHandler("MyPlaces.GetGeometryRequest",this.requestHandlers.getGeometryHandler)},stopPlugin:function(a){a.removeRequestHandler("MyPlaces.StartDrawingRequest",this.requestHandlers.startDrawingHandler);a.removeRequestHandler("MyPlaces.StopDrawingRequest",this.requestHandlers.stopDrawingHandler);a.removeRequestHandler("MyPlaces.GetGeometryRequest",this.requestHandlers.getGeometryHandler);a.unregister(this);this._map=null;this._sandbox=null},start:function(a){},stop:function(a){}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]});Oskari.clazz.define("Oskari.mapframework.myplaces.request.GetGeometryRequestPluginHandler",function(a,b){this.sandbox=a;this.drawPlugin=b},{handleRequest:function(a,c){var d=c.getCallBack();this.sandbox.printDebug("[Oskari.mapframework.myplaces.request.GetGeometryRequestPluginHandler] geometry requested");var b=this.drawPlugin.getDrawing();d(b.geometry)}},{protocol:["Oskari.mapframework.core.RequestHandler"]});Oskari.clazz.define("Oskari.mapframework.myplaces.request.StartDrawingRequestPluginHandler",function(a,b){this.sandbox=a;this.drawPlugin=b},{handleRequest:function(a,b){var c=b.getDrawMode();this.sandbox.printDebug("[Oskari.mapframework.myplaces.request.StartDrawingRequestPluginHandler] Start Drawing: "+c);this.drawPlugin.startDrawing({drawMode:b.getDrawMode(),geometry:b.getGeometry(),isModify:b.isModify(),style:""})}},{protocol:["Oskari.mapframework.core.RequestHandler"]});Oskari.clazz.define("Oskari.mapframework.myplaces.request.StopDrawingRequestPluginHandler",function(a,b){this.sandbox=a;this.drawPlugin=b},{handleRequest:function(a,b){this.sandbox.printDebug("[Oskari.mapframework.myplaces.request.StopDrawingRequestPluginHandler] Stop drawing");if(b.isPropagate()){this.drawPlugin.forceFinishDraw()}else{this.drawPlugin.stopDrawing()}}},{protocol:["Oskari.mapframework.core.RequestHandler"]});Oskari.clazz.define("Oskari.mapframework.myplaces.mapmodule.HoverPlugin",function(){this.mapModule=null;this.pluginName=null;this._sandbox=null;this._map=null},{__name:"MyPlaces.HoverPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(a){this.mapModule=a;this._map=a.getMap();this.pluginName=a.getName()+this.__name},init:function(a){var b=this;OpenLayers.Control.Hover=OpenLayers.Class(OpenLayers.Control,{defaultHandlerOptions:{delay:500,pixelTolerance:null,stopMove:false},initialize:function(c){this.handlerOptions=OpenLayers.Util.extend({},this.defaultHandlerOptions);OpenLayers.Control.prototype.initialize.apply(this,arguments);this.handler=new OpenLayers.Handler.Hover(this,{pause:this.onPause,move:this.onMove},this.handlerOptions)},onPause:function(c){},onMove:function(c){}});this.hoverControl=new OpenLayers.Control.Hover({handlerOptions:{delay:500,pixelTolerance:6},onPause:function(c){var e=b._map.getLonLatFromPixel(c.xy);var d=a.getEventBuilder("MyPlaces.MyPlaceHoverEvent")(e,c,b._map.getZoom());a.notifyAll(d)}});this._map.addControl(this.hoverControl)},activate:function(){this.hoverControl.activate()},deactivate:function(){this.hoverControl.deactivate()},register:function(){},unregister:function(){},startPlugin:function(a){this._sandbox=a;a.register(this)},stopPlugin:function(a){a.unregister(this);this._map=null;this._sandbox=null},start:function(a){},stop:function(a){}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]});
Oskari.clazz.define("Oskari.mapframework.myplaces.request.StopDrawingRequest",function(a){this._creator=null;if(a===true){this._propagateFinished=a}},{__name:"MyPlaces.StopDrawingRequest",getName:function(){return this.__name},isPropagate:function(){return(this._propagateFinished===true)}},{protocol:["Oskari.mapframework.request.Request"]});Oskari.clazz.define("Oskari.mapframework.myplaces.request.StartDrawingRequest",function(a){this._creator=null;if(a.geometry){this._geometry=a.geometry}else{if(a.continueCurrent){this._continueCurrent=a.continueCurrent}else{if(!this.drawModes[a.drawMode]){throw"Unknown draw mode '"+a.drawMode+"'"}this._drawMode=a.drawMode}}},{__name:"MyPlaces.StartDrawingRequest",getName:function(){return this.__name},isModify:function(){if(this._continueCurrent){return true}return false},drawModes:{point:"point",line:"line",area:"area"},getDrawMode:function(){return this._drawMode},getGeometry:function(){return this._geometry}},{protocol:["Oskari.mapframework.request.Request"]});Oskari.clazz.define("Oskari.mapframework.myplaces.request.GetGeometryRequest",function(a){this._creator=null;this._callbackMethod=a},{__name:"MyPlaces.GetGeometryRequest",getName:function(){return this.__name},getCallBack:function(){return this._callbackMethod}},{protocol:["Oskari.mapframework.request.Request"]});Oskari.clazz.define("Oskari.mapframework.service.MyPlacesService",function(c){this._config=c;this._categoryList=new Array();this._placesList=new Array();this.wfstStore=Oskari.clazz.create("Oskari.mapframework.service.MyPlacesWFSTStore",c.url,c.user);this.wfstStore.connect();this._sandbox=c.sandbox;this.defaults=c.defaults;var f=this;var e=function(){if(f.getAllCategories().length===0){}else{f._notifyDataChanged()}};var a=false;var b=false;var g=function(){a=true;if(f.getAllCategories().length===0&&c.defaults){var h=Ext.create("Oskari.mapframework.bundle.myplaces.model.MyPlacesCategory",{name:c.defaults.categoryName,lineWidth:c.defaults.lineWidth,lineColor:c.defaults.lineColor,fillColor:c.defaults.fillColor,dotColor:c.defaults.dotColor,dotSize:c.defaults.dotSize,isDefault:true});f.saveCategory(h,e)}else{if(b){f._notifyDataChanged()}}};var d=function(){b=true;if(a){f._notifyDataChanged()}b=true};this.wfstStore.getCategories(this,g);this.wfstStore.getMyPlaces(this,d)},{__qname:"Oskari.mapframework.service.MyPlacesService",getQName:function(){return this.__qname},__name:"MyPlacesService",getName:function(){return this.__name},_addCategory:function(a){this._categoryList.push(a)},_movePlacesToCategory:function(g,c,f){var e=this;var b=this.getPlacesInCategory(g);if(b.length==0){f(true);return}for(var d=0;d<b.length;d++){b[d].set("categoryID",c)}var a=function(i,h){e._notifyDataChanged();f(i,h[0])};this.wfstStore.commitMyPlaces(b,a)},_deletePlacesInCategory:function(f,g){var b=this.getPlacesInCategory(f);var e=[];for(var c=0;c<b.length;c++){e.push(b[c].get("id"))}if(e.length==0){g(true);return}var d=this;var a=function(k,j){if(k){for(var h=0;h<b.length;h++){d._removeMyPlace(j[h])}d._notifyDataChanged()}g(k)};this.wfstStore.deleteMyPlaces(e,a)},parseDate:function(c){if(!c&&c.length<10){return[]}var j=c.substring(0,4);var h=c.substring(5,7);var k=c.substring(8,10);var a=[k+"."+h+"."+j];var b="";if(c.length==29){b=c.substring(11);var i=b.split("+");b=i[0];b=b.split(".")[0];var f=b.split(":");var d=f[0];var e=f[1];var g=f[2];b=d+":"+e+":"+g;a.push(b)}return a},getPlacesInCategory:function(b){var c=[];for(var a=0;a<this._placesList.length;a++){if(this._placesList[a].get("categoryID")===b){c.push(this._placesList[a])}}return c},deleteCategory:function(e,d,f){var c=this;var a=function(h,g){if(h){c._deleteEmptyCategory(e,f)}else{f(h)}};if(d===true){var b=c.getDefaultCategory();c._movePlacesToCategory(e,b.get("id"),a)}else{c._deletePlacesInCategory(e,a)}},_deleteEmptyCategory:function(c,d){var b=this;var a=function(f,e){if(f){b._removeCategory(e[0])}d(f);b._notifyDataChanged()};this.wfstStore.deleteCategories([c],a)},_removeCategory:function(b){for(var a=0;a<this._categoryList.length;a++){if(this._categoryList[a].get("id")==b){this._categoryList.splice(a,1);
break}}},saveCategory:function(d,e){var c=this;var a=!(d.get("id"));var b=function(g,f){if(a&&g){c._addCategory(f[0])}else{}c._notifyDataChanged();e(g,f[0],a)};this.wfstStore.commitCategories([d],b)},getAllCategories:function(){return this._categoryList},getDefaultCategory:function(){var a=this.findBy(this._categoryList,"isDefault",true);if(a!==-1){return this._categoryList[a]}throw"Should not happen"},_addMyPlace:function(a){this._placesList.push(a)},_removeMyPlace:function(b){var a=this.findBy(this._placesList,"id",b);if(a!==-1){this._placesList.splice(a,1)}},_notifyDataChanged:function(){var a=this._sandbox.getEventBuilder("MyPlaces.MyPlacesChangedEvent")();this._sandbox.notifyAll(a)},deleteMyPlace:function(b,d){var c=this;var a=function(f,e){if(f){c._removeMyPlace(e[0]);c._notifyDataChanged()}d(f,e[0])};this.wfstStore.deleteMyPlaces([b],a)},findMyPlaceByLonLat:function(g,f){var c=[];var h=this.getAllMyPlaces();for(var d=0;d<h.length;++d){var e=h[d].get("geometry");var b=false;if("OpenLayers.Geometry.Point"===e.CLASS_NAME){var a=720-(f*f*5);if(f>10){a=5}else{if(f>8){a=20}else{if(f>5){a=50}}}b=e.atPoint(g,a,a)}else{b=e.atPoint(g)}if(b){c.push(h[d])}}return c},findMyPlace:function(b){var a=this.findBy(this._placesList,"id",b);if(a!==-1){return this._placesList[a]}return null},findCategory:function(b){var a=this.findBy(this._categoryList,"id",b);if(a!==-1){return this._categoryList[a]}return null},findBy:function(c,b,d){for(var a=0;a<c.length;a++){if(c[a].get(b)===d){return a}}return -1},saveMyPlace:function(b,e){var d=this;var a=!(b.get("id"));var c=function(h,g){if(a&&h){d._addMyPlace(g[0])}else{var f=d.findMyPlace(g[0].get("id"));if(f){f.set("updateDate",g[0].get("updateDate"))}else{h=false}}d._notifyDataChanged();e(h,g[0],a)};this.wfstStore.commitMyPlaces([b],c)},getAllMyPlaces:function(){return this._placesList}},{protocol:["Oskari.mapframework.service.Service"]});Oskari.clazz.define("Oskari.mapframework.service.MyPlacesWFSTStore",function(a,b){this.uuid=b;this.protocols={};this.url=a},{connect:function(){var a=this.url;this.protocols.categories=new OpenLayers.Protocol.WFS({version:"1.1.0",srsName:"EPSG:3067",featureType:"categories",featureNS:"http://www.paikkatietoikkuna.fi",url:a});this.protocols.my_places=new OpenLayers.Protocol.WFS({version:"1.1.0",srsName:"EPSG:3067",geometryName:"geometry",featureType:"my_places",featureNS:"http://www.paikkatietoikkuna.fi",url:a})},getCategories:function(b,a){var c=this.uuid;var f=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:"uuid",value:c});var e=this.protocols.categories;var d=this;e.read({filter:f,callback:function(g){d._handleCategoriesResponse(g,b,a)}})},_handleCategoriesResponse:function(e,i,d){var a=this.uuid;var g=e.features;if(g==null||g.length==0){if(d){d()}return}for(var c=0;c<g.length;c++){var h=g[c];var l=h.attributes;var b=this._parseNumericId(h.fid);var j=false;if("true"===l["default"]){j=true}var k={id:b,name:l.category_name,isDefault:j,lineWidth:l.stroke_width,lineColor:l.stroke_color,fillColor:l.fill_color,dotColor:l.dot_color,dotSize:l.dot_size,uuid:a};i._addCategory(Ext.create("Oskari.mapframework.bundle.myplaces.model.MyPlacesCategory",k))}if(d){d()}},commitCategories:function(i,k){var a=this.uuid;var b=this.protocols.categories;var j=this;var c=[];for(var f=0;f<i.length;f++){var d=i[f];var g=d.get("id");var e=d.get("isDefault");if(!e){e=false}var n={category_name:d.get("name"),"default":e,stroke_width:d.get("lineWidth"),stroke_color:d.get("lineColor"),fill_color:d.get("fillColor"),dot_color:d.get("dotColor"),dot_size:d.get("dotSize"),uuid:a};var h=new OpenLayers.Feature.Vector(null,n);if(!g){h.toState(OpenLayers.State.INSERT)}else{h.fid=b.featureType+"."+g;h.state=OpenLayers.State.UPDATE}c.push(h)}b.commit(c,{callback:function(l){j._handleCommitCategoriesResponse(l,i,k)}})},_handleCommitCategoriesResponse:function(f,j,d){if(f.success()){var c=f.reqFeatures;var a,l;var e=[];var k=f.insertIds||[];for(var g=0,h=c.length;g<h;++g){l=c[g];a=l.state;if(a){if(a==OpenLayers.State.INSERT){l.fid=k[g];l.attributes.id=l.fid;var b=this._parseNumericId(l.fid);
j[g].set("id",b)}l.state=null}}d(true,j)}else{d(false,j)}},deleteCategories:function(g,i){var b=this.protocols.categories;var a=this.uuid;var c=[];for(var d=0;d<g.length;d++){var e=g[d];if(!e){continue}var j={uuid:a};var f=new OpenLayers.Feature.Vector(null,j);f.fid=b.featureType+"."+e;f.state=OpenLayers.State.DELETE;c.push(f)}var h=this;b.commit(c,{callback:function(k){h._handleDeleteCategoriesResponse(k,g,i)}})},_handleDeleteCategoriesResponse:function(b,c,a){if(b.success()){a(true,c)}else{a(false,c)}},_parseNumericId:function(a){var b=a.split(".")[1];return b},getMyPlaces:function(b,a){var c=this.uuid;var f=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:"uuid",value:c});var e=this.protocols.my_places;var d=this;e.read({filter:f,callback:function(g){d._handleMyPlacesResponse(g,b,a)}})},_handleMyPlacesResponse:function(e,i,d){var a=this.uuid;var g=e.features;if(g==null){return}if(g.length==0){return}for(var c=0;c<g.length;c++){var h=g[c];var k=h.attributes;var b=this._parseNumericId(h.fid);var j={id:b,name:k.name,description:k.place_desc,categoryID:k.category_id,createDate:k.created,updateDate:k.updated,uuid:a,geometry:h.geometry};i._addMyPlace(Ext.create("Oskari.mapframework.bundle.myplaces.model.MyPlace",j))}if(d){d()}},getMyPlacesByIdList:function(f,b){var d=this.uuid;var g=this.protocols.my_places;var a=g.featureType+"."+id;var c=new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.AND,filters:[new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:"uuid",value:d}),new OpenLayers.Filter.FeatureId({fids:f})]});var e=this;g.read({filter:c,callback:function(h){e._handleMyPlaceByIdResponse(h,b)}})},_handleMyPlaceByIdResponse:function(g,e){var a=this.uuid;var h=g.features;if(h==null||h.length==0){return}var c=[];for(var d=0;d<h.length;d++){var i=h[d];var k=i.attributes;var b=this._parseNumericId(i.fid);var j={id:b,name:k.name,description:k.place_desc,categoryID:k.category_id,createDate:k.created,updateDate:k.updated,uuid:a,geometry:i.geometry};c.push(Ext.create("Oskari.mapframework.bundle.myplaces.model.MyPlace",j))}if(e){e(c)}},commitMyPlaces:function(h,k){var b=this.protocols.my_places;var a=this.uuid;var c=[];for(var e=0;e<h.length;e++){var d=h[e];var f=d.get("id");var j=d.get("geometry");var n={name:d.get("name"),place_desc:d.get("description"),category_id:d.get("categoryID"),uuid:a};var g=new OpenLayers.Feature.Vector(j,n);if(!f){g.toState(OpenLayers.State.INSERT)}else{g.fid=b.featureType+"."+f;g.state=OpenLayers.State.UPDATE}c.push(g)}var i=this;b.commit(c,{callback:function(l){i._handleCommitMyPlacesResponse(l,h,k)}})},_handleCommitMyPlacesResponse:function(f,k,d){if(f.success()){var c=f.reqFeatures;var a,n;var e=[];var m=f.insertIds||[];var l=[];for(var h=0,j=c.length;h<j;++h){n=c[h];a=n.state;if(a){if(a==OpenLayers.State.INSERT){n.fid=m[h];n.attributes.id=n.fid;var b=this._parseNumericId(n.fid);k[h].set("id",b);l.push(b)}else{l.push(k[h].get("id"))}n.state=null}}var g=function(i){d(true,i)};this.getMyPlacesByIdList(l,g)}else{d(false,k)}},deleteMyPlaces:function(g,i){var b=this.protocols.my_places;var a=this.uuid;var c=[];for(var d=0;d<g.length;d++){var e=g[d];if(!e){continue}var j={uuid:a};var f=new OpenLayers.Feature.Vector(null,j);f.fid=b.featureType+"."+e;f.state=OpenLayers.State.DELETE;c.push(f)}var h=this;b.commit(c,{callback:function(k){h._handleDeleteMyPlacesResponse(k,g,i)}})},_handleDeleteMyPlacesResponse:function(b,c,a){if(b.success()){a(true,c)}else{a(false,c)}},disconnect:function(){}},{protocol:["Oskari.mapframework.myplaces.service.Store"]});Oskari.clazz.define("Oskari.mapframework.ui.module.myplaces.MyPlacesModule",function(a){this._sandbox=null;this.uiItems={};this._config=a;this.myPlacesService=null;this.disableMapEvents=false;this.initialLoad=true;this.selectedMyPlace=null;this.localization={};this.defaults={};this.idPrefix="myplaces";this.defaults.dotColor="993300";this.defaults.lineColor="993300";this.defaults.fillColor="993300";this.defaults.lineWidth="1";this.defaults.dotSize="4";this.defaults.categoryName="Omat paikat"
},{__name:"MyPlacesModule",getName:function(){return this.__name},setDisableMapEvents:function(a){this.disableMapEvents=(a===true)},init:function(g){this._sandbox=g;var j=g;var f=this;j.printDebug("Initializing my places module...");this._populateLanguageSet(j);var d=j.getUser();if(d.isLoggedIn()){f._config.userKey=d.getUuid();this.defaults.categoryName=this.defaults.categoryName+" - "+d.getName()}var i=j.findRegisteredModuleInstance("MainMapModule");var a=Oskari.clazz.create("Oskari.mapframework.myplaces.mapmodule.DrawPlugin");i.registerPlugin(a);i.startPlugin(a);this.drawPlugin=a;var h=Oskari.clazz.create("Oskari.mapframework.myplaces.mapmodule.HoverPlugin");i.registerPlugin(h);i.startPlugin(h);this.hoverPlugin=h;this.myPlacesService=Oskari.clazz.create("Oskari.mapframework.service.MyPlacesService",{sandbox:j,user:f._config.userKey,url:f._config.actionUrl,defaults:f.defaults});for(var b in this.eventHandlers){j.registerForEventByName(this,b)}var e=Ext.create("Oskari.mapframework.bundle.myplaces.ui.view.MyPlacesGridPanel",{id:"myplaces-gridpanel",oskariConfig:{module:f,sandbox:j,service:f.myPlacesService,localizationSet:f.localization}});this.uiItems.gridPanel=e;var c=Ext.create("Oskari.mapframework.bundle.myplaces.ui.view.MyPlacesMainPanel",{id:"myplaces-mainpanel",oskariConfig:{module:f,sandbox:j,localizationSet:f.localization}});this.uiItems.mainPanel=c;this.wizardPanel=Ext.create("Oskari.mapframework.bundle.myplaces.ui.view.MyPlacesWizard",{oskariConfig:{service:f.myPlacesService,sandbox:f._sandbox,localizationSet:f.localization,module:f}});return c},_populateLanguageSet:function(b){var c=b.getLanguage();var a=Oskari.clazz.create("Oskari.mapframework.bundle.myplaces.ui.module.Locale",c);this.localization=a.getCurrentLocale();if("en"===c){this.defaults.categoryName="My places"}else{if("sv"===c){this.defaults.categoryName="Mina platser"}}if(!this.localization){this.localization=a.getLocale("fi")}},saveMyPlaceGeometry:function(){if(!this.selectedMyPlace){return}var b=this;var c=function(d){b.uiItems.mainPanel.setLoading(b.localization.savemask);b.selectedMyPlace.set("geometry",d);var e=function(f){b._saveMyPlaceGeometryCallback(f)};b.myPlacesService.saveMyPlace(b.selectedMyPlace,e)};var a=this._sandbox.getRequestBuilder("MyPlaces.GetGeometryRequest")(c);this._sandbox.request(this.getName(),a)},_saveMyPlaceGeometryCallback:function(d){var c=this;this.uiItems.mainPanel.setLoading(false);if(d){var a=this.getMapLayerId();var b=this._sandbox.getRequestBuilder("MapModulePlugin.MapLayerUpdateRequest")(a,true);this._sandbox.request(this.getName(),b)}else{alert(this.localization.errorSave)}},myPlaceFinished:function(c,d){var b=this;if(c){if(this.wizardPanel){this.wizardPanel.setLoading(this.localization.savemask)}var a=function(g,f,e){b._commitMyPlaceCallback(g,c,e,d)};this.myPlacesService.saveMyPlace(c,a)}else{this.cleanupAfterMyPlaceOperation()}},_commitMyPlaceCallback:function(f,e,a,g){var d=this;if(this.wizardPanel){this.wizardPanel.setLoading(false)}this.uiItems.mainPanel.setLoading(false);if(f){this.cleanupAfterMyPlaceOperation();var b=e.get("categoryID");this.uiItems.gridPanel.showCategory(b);var c=this._sandbox.getRequestBuilder("MapModulePlugin.MapLayerUpdateRequest")(this.getMapLayerId(b),true);this._sandbox.request(this.getName(),c);if(g!==b){var c=this._sandbox.getRequestBuilder("MapModulePlugin.MapLayerUpdateRequest")(this.getMapLayerId(g),true);this._sandbox.request(this.getName(),c)}}else{alert(this.localization.errorSave)}},cleanupAfterMyPlaceOperation:function(){var a=this._sandbox.getEventBuilder("MyPlaces.MyPlaceSelectedEvent")();this._sandbox.notifyAll(a);this.uiItems.mainPanel.sendStopDrawRequest();this.closeWizard()},startWizard:function(){var b=this;if(this.wizardPanel&&this.wizardPanel.isVisible()){this.closeWizard()}this.wizardPanel=Ext.create("Oskari.mapframework.bundle.myplaces.ui.view.MyPlacesWizard",{oskariConfig:{service:b.myPlacesService,sandbox:b._sandbox,localizationSet:b.localization,module:b}});var a=this.uiItems.gridPanel.getSelectedCategory();if(a){this.wizardPanel.setSelectedCategory(a.get("id"))
}this.wizardPanel.show();if(this.selectedMyPlace){this.wizardPanel.setPlace(this.selectedMyPlace)}},closeWizard:function(){if(this.wizardPanel){this.wizardPanel.hide();this.wizardPanel.removeAll(true);this.wizardPanel.destroy();this.wizardPanel=null}},start:function(a){a.printDebug("Starting "+this.getName());Oskari.$("UI.facade").addUIComponent(this.getName()+"_grid",this.uiItems.gridPanel,"S")},stop:function(a){Oskari.$("UI.facade").removeUIComponent(this.getName()+"_grid")},processStartupLinkLayers:function(k){var c=k.getRequestParameter("mapLayers");if(c===null||c===""){return}var g=c.split(",");var d=true;for(var f=0;f<g.length;f++){var j=g[f].split("+");var e=j[0];var h=j[1];if(e!==null&&e.indexOf(this.idPrefix)!==-1){var b=null;var a=null;b=k.getRequestBuilder("AddMapLayerRequest");a=b(e,d);k.request(this.getName(),a);b=k.getRequestBuilder("ChangeMapLayerOpacityRequest");a=b(e,h);k.request(this.getName(),a)}}},getDrawModeFromGeometry:function(b){var a=b.CLASS_NAME;if("OpenLayers.Geometry.Point"===a){return"point"}else{if("OpenLayers.Geometry.LineString"===a){return"line"}else{if("OpenLayers.Geometry.Polygon"===a){return"area"}}}return null},formatMessage:function(d,c){var b=d;for(var a in c){b=b.replace("{"+a+"}",c[a])}return b},deleteMyPlace:function(){var b=this;if(this.selectedMyPlace){this.uiItems.mainPanel.setLoading(this.localization.deletemask);var a=function(c){b._deleteMyPlaceCallback(c)};this.myPlacesService.deleteMyPlace(this.selectedMyPlace.get("id"),a)}},_deleteMyPlaceCallback:function(e){var d=this;var b=this.selectedMyPlace.get("categoryID");var a=this.getMapLayerId();this.uiItems.mainPanel.setLoading(false);if(e){this.cleanupAfterMyPlaceOperation()}else{alert(this.localization.errorDelete)}var c=this._sandbox.getRequestBuilder("MapModulePlugin.MapLayerUpdateRequest")(a,true);this._sandbox.request(this.getName(),c)},handleFinishedDrawingEvent:function(a){if(!a.isModification()){this.startWizard()}},getSelectedPlace:function(){return this.selectedMyPlace},_handlePlacesChanged:function(){if(this.wizardPanel){this.wizardPanel.refreshCategories()}var e=this._sandbox.getService("Oskari.mapframework.service.MapLayerService");var d=this.myPlacesService.getAllCategories();var b=e.getAllLayersByMetaType(this.idPrefix);for(var c=0;c<b.length;++c){var f=b[c];var m=false;for(var g=0;g<d.length;++g){var h=d[g];if(this.getMapLayerId(h.get("id"))===f.getId()){m=true}}if(!m){this._sandbox.requestByName(this.getName(),"RemoveMapLayerRequest",[f.getId()]);e.removeLayer(f.getId());var l=f.getId().substring(this.idPrefix.length+1);this.uiItems.gridPanel.removeCategory(l)}}for(var g=0;g<d.length;++g){var h=d[g];var m=false;for(var c=0;c<b.length;++c){if(this.getMapLayerId(h.get("id"))===b[c].getId()){m=true;if(h.get("name")!==b[c].getName()){var a={name:h.get("name")};e.updateLayer(b[c].getId(),a)}}}if(!m){var k=this.getMapLayerJson(h);var j=e.createMapLayer(k);e.addLayer(j)}this.uiItems.gridPanel.addOrUpdateCategory(h)}if(this.initialLoad){this.processStartupLinkLayers(this._sandbox);this.initialLoad=false;this.uiItems.gridPanel.showCategory()}},handleMyPlaceSelected:function(a){this.selectedMyPlace=a;if(this.wizardPanel&&this.wizardPanel.isVisible()){this.wizardPanel.setPlace(this.selectedMyPlace)}this.uiItems.mainPanel.placeSelected(a)},eventHandlers:{"MyPlaces.FinishedDrawingEvent":function(a){this.handleFinishedDrawingEvent(a)},"MyPlaces.MyPlaceSelectedEvent":function(a){Oskari.$("UI.facade").expandPart("E");this.uiItems.mainPanel.expand(true);this.handleMyPlaceSelected(a.getPlace());if(a.isDblClick()){this.startWizard()}},"MyPlaces.MyPlacesChangedEvent":function(a){this._handlePlacesChanged()},"MyPlaces.MyPlaceHoverEvent":function(a){if(this.disableMapEvents===false){this.uiItems.gridPanel.handleHover(a)}},AfterMapLayerRemoveEvent:function(d){var c=d.getMapLayer();if(c.getMetaType&&c.getMetaType()===this.idPrefix){var a=this._sandbox.getService("Oskari.mapframework.service.MapLayerService");var b=a.getAllLayersByMetaType(this.idPrefix);if(b.length===0){this.hoverPlugin.deactivate()}}},MapClickedEvent:function(a){if(this.disableMapEvents===false){this.uiItems.gridPanel.handleMapClick(a)
}},AfterMapLayerAddEvent:function(c){var b=c.getMapLayer();if(b.getMetaType&&b.getMetaType()===this.idPrefix){Oskari.$("UI.facade").expandPart("E");this.uiItems.mainPanel.expand(true);Oskari.$("UI.facade").showUIComponent(this.getName()+"_grid");var a=b.getId().substring(this.idPrefix.length+1);this.uiItems.gridPanel.showCategory(a);this.hoverPlugin.activate()}}},onEvent:function(b){var a=this.eventHandlers[b.getName()];if(!a){return}return a.apply(this,[b])},addLayerToMap:function(d){var a=this.getMapLayerId(d);var b=this._sandbox.findMapLayerFromSelectedMapLayers(a);if(!b){var c=this._sandbox.getRequestBuilder("AddMapLayerRequest")(a,true);this._sandbox.request(this.getName(),c)}},getMapLayerId:function(b){if(!b){if(this.selectedMyPlace){b=this.selectedMyPlace.get("categoryID")}else{var a=this.myPlacesService.getDefaultCategory();if(a){b=a.get("id")}else{b="-99"}}}return this.idPrefix+"_"+b},getMapLayerJson:function(b){var a=this._getMapLayerJsonBase();a.wmsUrl=this._config.wmsUrl+b.get("id")+"&";a.name=b.get("name");a.id=this.getMapLayerId(b.get("id"));return a},_getMapLayerJsonBase:function(){var a={wmsName:"ows:my_places_categories",descriptionLink:"",orgName:this.localization.title,type:"wmslayer",metaType:this.idPrefix,baseLayerId:-1,legendImage:"",gfi:"disabled",formats:{value:"text/html"},isQueryable:false,minScale:12000000,opacity:75,inspire:this.localization.title,maxScale:1};return a}},{protocol:["Oskari.mapframework.module.Module"]});Oskari.clazz.define("Oskari.mapframework.bundle.myplaces.ui.module.Locale",function(a){this.lang=a;this.loc=this.__locale[a]},{__locale:{fi:{title:"Omat paikat <b style='color:#F4A529'>BETA</b>",saveBtn:"Tallenna",deleteConfirmTitle:"Poistetaanko?",loadmask:"Ladataan...",savemask:"Tallennetaan...",deletemask:"Poistetaan...",errorSave:"Virhe tallennuksessa!",errorDelete:"Virhe poistossa!",mainpanel:{myPlacesDesc:"Toiminnolla voit tallentaa kohteita kartalle. Kohteet löytyvät Omat paikat -karttatasoilta. Aloita valitsemalla kohteen tyyppi:",btnPoint:"Lisää piste",btnLine:"Lisää reitti",btnArea:"Lisää alue",drawHelp:{point:"Lisää piste klikkaamalla kartalla.",line:'Lisää viivan taitepiste klikkaamalla kartalla. Lopeta piirto tuplaklikkauksella tai painamalla "Lopeta piirto".',area:'Lisää alueen taitepiste klikkaamalla kartalla. Lopeta piirto tuplaklikkauksella tai painamalla "Lopeta piirto".'},btnCancelDraw:"Keskeytä piirto",btnFinishDraw:"Lopeta piirto",selectionHelp:"Kohteen saat valittua muokattavaksi klikkaamalla sitä kartalla tai taulukossa.",editHelp:{point:"Siirrä pistettä raahaamalla sitä kartalla.",line:"Muokkaa viivaa raahaamalla viivan taitepisteitä kartalla.",area:"Muokkaa muotoa raahaamalla reunaviivan taitepisteitä kartalla.",desc:'Muokkaa kohteen tietoja painamalla "Muokkaa" nappia.'},editSaveBtn:{point:"Tallenna sijainti",line:"Tallenna muoto",area:"Tallenna muoto"},btnEdit:"Muokkaa",deleteHelp:'Valitun kohteen saat poistettua painamalla "Poista" nappia.',btnDelete:"Poista",deleteConfirm:"Paikan nimi: "},wizard:{title:"Kohteen tiedot",categoryLabel:"Karttataso"},myplace:{addTip:"Lisää uusi karttataso",editTip:"Muokkaa karttatasoa",cancelBtn:"Sulje tallentamatta",placeName:"Nimi",placeDesc:"Kuvaus",placeCreateDate:"Kohde luotu",placeUpdateDate:"Kohde päivitetty",errorNoName:"Anna paikalle nimi",errorCategoryNotSelected:"Valitse karttataso tai anna uudelle karttatasolle nimi"},category:{deleteTip:"Poista karttataso",lineColorLabel:"Viivan tai reunaviivan väri",fillColorLabel:"Alueen täyttöväri",lineWidthLabel:"Viivan tai reunaviivan leveys",dotSizeLabel:"Pisteen koko",dotColorLabel:"Pisteen väri",backBtn:"Takaisin",errorNoName:"Anna karttatasolle nimi",errorDeleteDefault:"Oletuskarttatasoa ei voi poistaa"},confirm:{deleteConfirm:'Karttataso: "{0}". Sisältää paikkoja: {1} kpl.',deleteConfirmMoveText:'Haluatko siirtää paikat oletuskarttatasolle "{0}"?',btnMove:"Siirrä paikat ja poista karttataso",btnDelete:"Poista karttataso",btnDeleteAll:"Poista karttataso paikkoineen",btnCancel:"Peruuta"},grid:{title:"Omat paikat <b style='color:#F4A529'>BETA</b>",placeName:"Nimi",placeDesc:"Kuvaus",linkHeader:"Kohdistus",linkValue:"Näytä kohde",type:{label:"Tyyppi",point:"Piste",line:"Viiva",area:"Alue"},createDate:"Kohde luotu",updateDate:"Kohde päivitetty"}},sv:{title:"Mina platser <b style='color:#F4A529'>BETA</b>",saveBtn:"Spara",deleteConfirmTitle:"Radera?",loadmask:"Laddar...",savemask:"Lagrar...",deletemask:"Raderar...",errorSave:"Fel vid lagring!",errorDelete:"Fel vid radering!",mainpanel:{myPlacesDesc:'Du kan lagra objekt på kartan med funktionen "Mina platser". Objekten finns på kartlagren Mina platser. Börja genom att välja typen av objekt:',btnPoint:"Tillsätt punkt",btnLine:"Tillsätt rutt",btnArea:"Tillsätt område",drawHelp:{point:"Tillägg en punkt genom att klicka på kartan.",line:'Tillägg en brytningspunkt på linjen genom att klicka på kartan. Sluta rita genom att dubbelklicka, eller klicka på knappen "Avsluta ritandet".',area:'Tillägg en brytningspunkt på området genom att klicka på kartan. Sluta rita genom att dubbelklicka, eller klicka på knappen "Avsluta ritandet".'},btnCancelDraw:"Avbryt ritandet",btnFinishDraw:"Avsluta ritandet",selectionHelp:"Du kan bearbeta objektet genom att klicka det på kartan eller i tabellen.",editHelp:{point:"Flytta på punkten genom att klicka och släpa det på kartan.",line:"Bearbeta rutten genom att klicka och släpa dess brytningspunkt på kartan.",area:"Bearbeta figuren genom att klicka och släpa kantlinjens brytningspunkter på kartan.",desc:'Bearbeta informationen om objektet genom att klicka på "Bearbeta".'},editSaveBtn:{point:"Spara läge",line:"Spara figur",area:"Spara figur"},btnEdit:"Bearbeta",deleteHelp:'Radera det valda objektet genom att klicka på "Radera".',btnDelete:"Radera",deleteConfirm:"Platsens namn: "},wizard:{title:"Information om objektet",categoryLabel:"Kartlager"},myplace:{addTip:"Tillägg ett kartlager",editTip:"Bearbeta kartlagret",cancelBtn:"Stäng utan att lagra",placeName:"Namn",placeDesc:"Beskrivning",placeCreateDate:"Objektet skapades",placeUpdateDate:"Objektet uppdaterades",errorNoName:"Namnge platsen",errorCategoryNotSelected:"Välj kartlager eller namnge ett nytt kartlager"},category:{deleteTip:"Radera kartlagret",lineColorLabel:"Linjens eller kantlinjens färg",fillColorLabel:"Områdets ifyllnadsfärg",lineWidthLabel:"Linjens eller kantlinjens bredd",dotSizeLabel:"Punktens storlek",dotColorLabel:"Punktens färg",backBtn:"Tillbaka",errorNoName:"Namnge kartlagret",errorDeleteDefault:"Det förvalda kartlagret kan inte raderas"},confirm:{deleteConfirm:'Kartlager: "{0}". Antal platser: {1}',deleteConfirmMoveText:'Vill du flytta platserna till det förvalda kartlagret "{0}"?',btnMove:"Flytta platserna och radera kartlagret",btnDelete:"Radera kartlagret",btnDeleteAll:"Radera kartlagret inkl. platserna",btnCancel:"Tillbaka"},grid:{title:"Mina platser <b style='color:#F4A529'>BETA</b>",placeName:"Namn",placeDesc:"Beskrivning",linkHeader:"Fokusering",linkValue:"Vis objekt",type:{label:"Typ",point:"Punkt",line:"Linje",area:"Område"},createDate:"Objektet skapades",updateDate:"Objektet uppdaterades"}},en:{title:"My places <b style='color:#F4A529'>BETA</b>",saveBtn:"Save",deleteConfirmTitle:"Delete?",loadmask:"Loading...",savemask:"Saving...",deletemask:"Deleting...",errorSave:"Error while saving!",errorDelete:"Error while deleting!",mainpanel:{myPlacesDesc:'The function My places allows you to save objects on the map. Saved objects are stored in map layer group "My places". Please start by selecting type of object:',btnPoint:"Add point",btnLine:"Add route",btnArea:"Add area",drawHelp:{point:"Add a point by clicking on the map.",line:'Add a handle on the line by clicking on the map. Stop drawing by double-clicking or by clicking the button "Stop drawing".',area:'Add a handle on the boundary line of the area by clicking on the map. Stop drawing by double-clicking or by clicking the button "Stop drawing".'},btnCancelDraw:"Cancel drawing",btnFinishDraw:"Stop drawing",selectionHelp:"Start editing an object by clicking it on the map or in the table.",editHelp:{point:"Move a point object by clicking and dragging it on the map.",line:"Move and edit a route object by clicking and dragging the line handles on the map.",area:"Move and edit an area object by clicking and dragging the boundary line handles on the map.",desc:'Edit object information by clicking the "Edit"-button.'},editSaveBtn:{point:"Save location",line:"Save shape",area:"Save shape"},btnEdit:"Edit",deleteHelp:'Delete selected object by clicking the "Remove"-button.',btnDelete:"Delete",deleteConfirm:"Object name: "},wizard:{title:"Object information",categoryLabel:"Map layer"},myplace:{addTip:"Add a new map layer",editTip:"Edit map layer",cancelBtn:"Close without saving",placeName:"Name",placeDesc:"Description",placeCreateDate:"Object created",placeUpdateDate:"Object updated",errorNoName:"Type object name",errorCategoryNotSelected:"Select a map layer or type the name of a new map layer"},category:{deleteTip:"Delete map layer",lineColorLabel:"Colour of line or area boundary",fillColorLabel:"Fill colour of area",lineWidthLabel:"Width of line or area boundary",dotSizeLabel:"Point size",dotColorLabel:"Point colour",backBtn:"Back",errorNoName:"Type map layer name",errorDeleteDefault:"The default map layer cannot be deleted"},confirm:{deleteConfirm:'Map layer: "{0}". Number of places: {1}.',deleteConfirmMoveText:'Do you want to move places to the default map layer "{0}"?',btnMove:"Move places and delete map layer",btnDelete:"Delete map layer",btnDeleteAll:"Delete map layer and its places",btnCancel:"Cancel"},grid:{title:"My places <b style='color:#F4A529'>BETA</b>",placeName:"Name",placeDesc:"Description",linkHeader:"Focus",linkValue:"Show object",type:{label:"Type",point:"Point",line:"Line",area:"Area"},createDate:"Object created",updateDate:"Object updated"}}},getCurrentLocale:function(){return this.loc
},getLocale:function(a){return this.__locale[a]},getText:function(a){return this.loc[a]}});Ext.define("Oskari.mapframework.bundle.myplaces.ui.view.CategoryPanel",{extend:"Ext.panel.Panel",layout:"fit",border:false,frame:false,initComponent:function(){var a={};a.uiItems={};a.category=null;a.defaults=this.oskariConfig.defaults;a.loc={};a.loc.deleteTip=this.oskariConfig.localizationSet.category.deleteTip;a.loc.categoryLabel=this.oskariConfig.localizationSet.wizard.categoryLabel;a.loc.lineColorLabel=this.oskariConfig.localizationSet.category.lineColorLabel;a.loc.fillColorLabel=this.oskariConfig.localizationSet.category.fillColorLabel;a.loc.lineWidthLabel=this.oskariConfig.localizationSet.category.lineWidthLabel;a.loc.dotColorLabel=this.oskariConfig.localizationSet.category.dotColorLabel;a.loc.dotSizeLabel=this.oskariConfig.localizationSet.category.dotSizeLabel;a.loc.backBtn=this.oskariConfig.localizationSet.category.backBtn;a.loc.saveBtn=this.oskariConfig.localizationSet.saveBtn;a.loc.deleteConfirmTitle=this.oskariConfig.localizationSet.deleteConfirmTitle;a.loc.deleteConfirm=this.oskariConfig.localizationSet.category.deleteConfirm;a.loc.errorNoName=this.oskariConfig.localizationSet.category.errorNoName;a.loc.errorDeleteDefault=this.oskariConfig.localizationSet.category.errorDeleteDefault;this._buildItems(a);this._buildDockedButtons(a);Ext.apply(this,Ext.apply(this.initialConfig,a));this.callParent(arguments)},setParams:function(f){var d=this;if(f.isNew||f.categoryModel.get("isDefault")){d.uiItems.deleteCategoryButton.disable()}else{d.uiItems.deleteCategoryButton.enable()}d.uiItems.categoryName.setValue(f.categoryModel.get("name"));var a=f.categoryModel.get("lineWidth");if(!a){a=d.defaults.lineWidth}d.uiItems.lineWidthCombo.select(a);var b=f.categoryModel.get("dotSize");if(!b){b=d.defaults.dotSize}d.uiItems.dotSizeCombo.select(b);var g=f.categoryModel.get("fillColor");if(!g){g=d.defaults.fillColor}d.uiItems.fillColorPicker.select(g);var e=f.categoryModel.get("lineColor");if(!e){e=d.defaults.lineColor}d.uiItems.lineColorPicker.select(e);var c=f.categoryModel.get("dotColor");if(!c){c=d.defaults.dotColor}d.uiItems.dotColorPicker.select(c);d.category=f.categoryModel},_buildItems:function(d){var i=Ext.create("Ext.picker.Color",{value:d.defaults.dotColor,fieldLabel:d.loc.dotColorLabel});d.uiItems.dotColorPicker=i;var j=Ext.create("Ext.picker.Color",{value:d.defaults.lineColor,fieldLabel:d.loc.lineColorLabel});d.uiItems.lineColorPicker=j;var l=Ext.create("Ext.picker.Color",{value:d.defaults.fillColor,fieldLabel:d.loc.fillColorLabel});d.uiItems.fillColorPicker=l;var n=Ext.create("Ext.data.Store",{fields:["lineWidth"],data:[{lineWidth:"1"},{lineWidth:"2"},{lineWidth:"4"},{lineWidth:"8"},{lineWidth:"16"}]});var k=Ext.create("Ext.data.Store",{fields:["dotSize"],data:[{dotSize:"1"},{dotSize:"2"},{dotSize:"4"},{dotSize:"8"},{dotSize:"16"}]});var f=Ext.create("Ext.form.ComboBox",{fieldLabel:d.loc.dotSizeLabel,border:true,frame:true,editable:false,forceSelection:true,value:d.defaults.dotSize,store:k,displayField:"dotSize",valueField:"dotSize",queryMode:"local"});d.uiItems.dotSizeCombo=f;var h=Ext.create("Ext.form.ComboBox",{fieldLabel:d.loc.lineWidthLabel,border:true,frame:true,editable:false,forceSelection:true,value:d.defaults.lineWidth,store:n,displayField:"lineWidth",valueField:"lineWidth",queryMode:"local"});d.uiItems.lineWidthCombo=h;var a=Ext.create("Ext.panel.Panel",{bodyPadding:10,layout:"fit",items:[{xtype:"label",forId:"dotColorPicker",text:d.loc.dotColorLabel},i]});var b=Ext.create("Ext.panel.Panel",{bodyPadding:10,layout:"fit",items:[{xtype:"label",forId:"lineColorPicker",text:d.loc.lineColorLabel},j]});var g=Ext.create("Ext.panel.Panel",{bodyPadding:10,layout:"fit",items:[{xtype:"label",forId:"fillColorPicker",text:d.loc.fillColorLabel},l]});var e=Ext.create("Ext.panel.Panel",{border:false,frame:false,bodyPadding:10,layout:"hbox",items:[a,b,g]});var m=Ext.create("Ext.panel.Panel",{border:false,frame:false,bodyPadding:10,layout:"hbox",items:[f,h]});var c=Ext.create("Ext.form.Panel",{border:false,frame:false,bodyPadding:10,items:[e,m]});
d.uiItems.mainPanel=c;d.items=[c]},_cancelCategoryEdit:function(){this.cancelAction()},_commitCategoryEdit:function(){var a=this;var b=a.uiItems.categoryName.getValue().trim();if(!b){alert(a.loc.errorNoName)}else{a.category.set("name",a.uiItems.categoryName.getValue());a.category.set("lineWidth",a.uiItems.lineWidthCombo.getValue());a.category.set("fillColor",a.uiItems.fillColorPicker.getValue());a.category.set("lineColor",a.uiItems.lineColorPicker.getValue());a.category.set("dotSize",a.uiItems.dotSizeCombo.getValue());a.category.set("dotColor",a.uiItems.dotColorPicker.getValue());this.finishedAction(a.category)}},_buildDockedButtons:function(a){var c=this;var e=Ext.create("Ext.form.TextField",{fieldLabel:a.loc.categoryLabel,emptyText:a.loc.errorNoName,flex:1});a.uiItems.categoryName=e;var f=Ext.create("Ext.button.Button",{cls:"x-btn-icon",scale:"small",iconCls:"myplaces_delete_category",tooltip:a.loc.deleteTip,handler:function(){if(c.category.get("isDefault")){alert(c.loc.errorDeleteDefault);return}c.deleteCategoryAction(c.category)}});a.uiItems.deleteCategoryButton=f;var d=Ext.create("Ext.Button",{text:a.loc.saveBtn,handler:function(){c._commitCategoryEdit()}});a.uiItems.saveButton=d;var b=Ext.create("Ext.Button",{text:a.loc.backBtn,handler:function(){c._cancelCategoryEdit()}});a.uiItems.backButton=b;a.dockedItems=[{xtype:"toolbar",dock:"top",items:[e,f]},{xtype:"toolbar",dock:"bottom",items:[{xtype:"tbfill"},b,d]}]}});Ext.define("Oskari.mapframework.bundle.myplaces.ui.view.ConfirmWindow",{extend:"Ext.window.Window",modal:true,width:400,layout:"fit",cls:Ext.baseCSSPrefix+"message-box",initComponent:function(){var a={};a.uiItems={};this._buildItems(a);this._buildDockedButtons(a);Ext.apply(this,Ext.apply(this.initialConfig,a));this.callParent(arguments)},_createButton:function(c){var b=this;var a=Ext.create("Ext.Button",{text:c.text,handler:function(){b.destroy();if(c.handler){c.handler()}}});return a},_buildItems:function(a){var b=this;b.topContainer=Ext.create("Ext.container.Container",{anchor:"100%",style:{padding:"10px",overflow:"hidden"},items:[b.iconComponent=Ext.create("Ext.Component",{cls:"ext-mb-icon "+Ext.Msg.QUESTION,width:50,height:35,style:{"float":"left"}}),b.promptContainer=Ext.create("Ext.container.Container",{layout:{type:"anchor"},items:[b.msg=Ext.create("Ext.Component",{autoEl:{tag:"span"},cls:"ext-mb-text",html:b.message})]})]});a.items=[b.topContainer]},_buildDockedButtons:function(b){var d=this;var e=[];for(var a in this.dialogButtons){var f=this.dialogButtons[a];if(f=="break"){e.push({xtype:"tbfill"})}else{var c=this._createButton(f);e.push(c)}}b.dockedItems=[{xtype:"toolbar",ui:"footer",dock:"bottom",items:e}]}});Ext.define("Oskari.mapframework.bundle.myplaces.ui.view.MyPlacePanel",{extend:"Ext.panel.Panel",layout:"fit",border:false,frame:false,initComponent:function(){var a={};a.uiItems={};a.myPlace=Ext.create("Oskari.mapframework.bundle.myplaces.model.MyPlace",{name:"",description:""});a.loc={};a.loc.categoryLabel=this.oskariConfig.localizationSet.wizard.categoryLabel;a.loc.cancelBtn=this.oskariConfig.localizationSet.myplace.cancelBtn;a.loc.finishBtn=this.oskariConfig.localizationSet.saveBtn;a.loc.placeName=this.oskariConfig.localizationSet.myplace.placeName;a.loc.placeDesc=this.oskariConfig.localizationSet.myplace.placeDesc;a.loc.placeCreateDate=this.oskariConfig.localizationSet.myplace.placeCreateDate;a.loc.placeUpdateDate=this.oskariConfig.localizationSet.myplace.placeUpdateDate;a.loc.errorNoName=this.oskariConfig.localizationSet.myplace.errorNoName;a.loc.errorCategoryNotSelected=this.oskariConfig.localizationSet.myplace.errorCategoryNotSelected;a.loc.addTip=this.oskariConfig.localizationSet.myplace.addTip;a.loc.editTip=this.oskariConfig.localizationSet.myplace.editTip;a.category={};a.items=[this._buildItems(a)];this._buildDockedButtons(a);Ext.apply(this,Ext.apply(this.initialConfig,a));this.callParent(arguments)},_buildItems:function(a){var b=this._createFormFields(a);var c=Ext.create("Ext.form.Panel",{id:"myplace-popup-placepanel",border:false,frame:false,padding:10,hideMode:"offsets",style:"text-align: left;",fieldDefaults:{labelAlign:"top",msgTarget:"top"},defaults:{anchor:"100%"},items:b});
a.uiItems.mainPanel=c;return c},_createFormFields:function(c){var e=this;if(!c.myPlace){c.myPlace=Ext.create("Oskari.mapframework.bundle.myplaces.model.MyPlace",{name:"",description:""})}var d=[];var a=Ext.create("Ext.form.Text",{xtype:"textfield",name:"name",emptyText:c.loc.errorNoName,fieldLabel:c.loc.placeName,value:c.myPlace.get("name"),allowBlank:false});d.push(a);var b=Ext.create("Ext.form.TextArea",{name:"description",grow:false,value:c.myPlace.get("description"),fieldLabel:c.loc.placeDesc});d.push(b);if(c.myPlace.get("createDate")){var f=e._formatDate(c.myPlace.get("createDate"));d.push({xtype:"displayfield",labelAlign:"left",fieldLabel:c.loc.placeCreateDate,name:"createDate",value:f});f=e._formatDate(c.myPlace.get("updateDate"));d.push({xtype:"displayfield",labelAlign:"left",fieldLabel:c.loc.placeUpdateDate,name:"updateDate",value:f})}return d},_formatDate:function(b){var c=this.oskariConfig.service.parseDate(b);var e="";if(c.length==0){return""}else{if(c.length>1){var a=Oskari.$().startup.imageLocation+"/resource/silk-icons/clock.png";e='<img src="'+a+'" /> '+c[1]}}var d=Oskari.$().startup.imageLocation+"/resource/silk-icons/calendar.png";return'<img src="'+d+'" /> '+c[0]+" "+e},setPlace:function(a){if(a){this.myPlace=a;this.setSelectedCategory(a.get("categoryID"))}else{this.myPlace=Ext.create("Oskari.mapframework.bundle.myplaces.model.MyPlace",{name:"",description:""})}},saveValues:function(){var b=this.uiItems.mainPanel.getValues();this.myPlace.set("name",b.name);this.myPlace.set("description",b.description);try{var d=this._getCategorySelectionIndex();var c=this.categoryStore.getAt(d);this.myPlace.set("categoryID",c.get("id"))}catch(a){}},recreatePanel:function(){this.uiItems.mainPanel.removeAll();var a=this._createFormFields(this);this.uiItems.mainPanel.add(a)},_myPlaceFinished:function(){var b=this;try{var d=b.myPlace.get("categoryID");this.saveValues();if(!b.myPlace.get("name")){alert(b.loc.errorNoName);return}var c=this._getCategorySelectionIndex();this.finishedAction(b.myPlace,d)}catch(a){alert(a)}},_myPlaceCanceled:function(){this.finishedAction()},_getCategorySelectionIndex:function(){var b=this;var c=b.uiItems.categoryDropdown.getValue();if(!c){throw b.loc.errorCategoryNotSelected}var a=b.categoryStore.findBy(function(d,e){if(isNaN(c)){return d.get("name")==c}return d.get("id")==c});return a},_handleCategoryControls:function(i){var g=this;var f=-1;try{f=g._getCategorySelectionIndex()}catch(h){if(!i){alert(h);return}}var d=null;var c=(f==-1);var e=(c||i);if(e){var a="";if(c){a=g.uiItems.categoryDropdown.getValue()}d=Ext.create("Oskari.mapframework.bundle.myplaces.model.MyPlacesCategory",{name:a})}else{d=g.categoryStore.getAt(f)}var b={isNew:e,categoryModel:d};g.categoryOperation(b)},setCategories:function(a){var b=this;b.categoryStore.loadData(a)},setSelectedCategory:function(c){var b=this;if(!c){var a=this.oskariConfig.service.getDefaultCategory();c=a.get("id")}b.uiItems.categoryDropdown.setValue(c)},_handleCategoryButtons:function(){var c=this;try{var b=c._getCategorySelectionIndex();if(b==-1){this.uiItems.editCategoryButton.disable()}else{this.uiItems.editCategoryButton.enable()}}catch(a){}},_buildDockedButtons:function(d){var f=this;var a=Ext.create("Ext.form.ComboBox",{fieldLabel:d.loc.categoryLabel,store:f.categoryStore,id:"myplace-category-dropdown",typeAhead:true,typeAheadDelay:1000,flex:1,queryMode:"local",displayField:"name",valueField:"id",listeners:{specialKey:function(i,h){if(h.getKey()==h.ENTER){f._handleCategoryControls(false)}}}});d.uiItems.categoryDropdown=a;a.setValue(f.categoryStore.getAt(0));a.on("change",function(){f._handleCategoryButtons()});var b=Ext.create("Ext.button.Button",{cls:"x-btn-icon",scale:"small",iconCls:"myplaces_add_category",tooltip:d.loc.addTip,handler:function(){f._handleCategoryControls(true)}});d.uiItems.addCategoryButton=b;var e=Ext.create("Ext.button.Button",{cls:"x-btn-icon",scale:"small",iconCls:"myplaces_edit_category",tooltip:d.loc.editTip,handler:function(){f._handleCategoryControls(false)}});d.uiItems.editCategoryButton=e;var c=Ext.create("Ext.Button",{text:d.loc.finishBtn,handler:function(){f._myPlaceFinished()
}});d.uiItems.finishedButton=c;var g=Ext.create("Ext.Button",{text:d.loc.cancelBtn,handler:function(){f._myPlaceCanceled()}});d.uiItems.cancelButton=g;d.dockedItems=[{xtype:"toolbar",dock:"top",items:[a,e,b]},{xtype:"toolbar",dock:"bottom",items:[{xtype:"tbfill"},g,c]}]}});Ext.define("Oskari.mapframework.bundle.myplaces.ui.view.MyPlacesBasicControls",{extend:"Ext.panel.Panel",layout:"anchor",border:false,frame:false,initComponent:function(){var a={};a.uiItems={};a.mainPanel=this.oskariConfig.mainPanel;this._buildItems(a);Ext.apply(this,Ext.apply(this.initialConfig,a));this.callParent(arguments)},_buildItems:function(e){var g=this;var b=Ext.create("Ext.form.Label",{text:this.oskariConfig.localizationSet.mainpanel.myPlacesDesc});var a=Ext.create("Ext.Button",{tooltip:this.oskariConfig.localizationSet.mainpanel.btnPoint,cls:"x-btn-icon",scale:"large",flex:1,iconCls:"myplaces_draw_point",handler:function(){g.mainPanel.startNewDrawing({drawMode:"point"})}});var h=Ext.create("Ext.Button",{tooltip:this.oskariConfig.localizationSet.mainpanel.btnLine,cls:"x-btn-icon",scale:"large",flex:1,iconCls:"myplaces_draw_line",handler:function(){g.mainPanel.startNewDrawing({drawMode:"line"})}});var c=Ext.create("Ext.Button",{tooltip:this.oskariConfig.localizationSet.mainpanel.btnArea,cls:"x-btn-icon",scale:"large",flex:1,iconCls:"myplaces_draw_area",handler:function(){g.mainPanel.startNewDrawing({drawMode:"area"})}});e.uiItems.btnPoint=a;e.uiItems.btnLine=h;e.uiItems.btnArea=c;var f=Ext.create("Ext.panel.Panel",{border:false,frame:false,layout:"anchor",bodyPadding:"5 25",items:[a,h,c]});var d=Ext.create("Ext.form.Label",{text:this.oskariConfig.localizationSet.mainpanel.selectionHelp});e.items=[b,f,d]}});Ext.define("Oskari.mapframework.bundle.myplaces.ui.view.MyPlacesDrawControls",{extend:"Ext.panel.Panel",layout:"anchor",border:false,frame:false,initComponent:function(){var a={};a.uiItems={};a.category=null;a.module=this.oskariConfig.module;a.mainPanel=this.oskariConfig.mainPanel;this._buildItems(a);Ext.apply(this,Ext.apply(this.initialConfig,a));this.callParent(arguments)},setDrawMode:function(a){this.uiItems.drawHelp.update(this.oskariConfig.localizationSet.mainpanel.drawHelp[a]);if("point"===a){this.uiItems.btnFinishDraw.hide()}else{this.uiItems.btnFinishDraw.show()}},_buildItems:function(c){var e=this;var a=Ext.create("Ext.form.Label");c.uiItems.drawHelp=a;var g=Ext.create("Ext.Button",{text:this.oskariConfig.localizationSet.mainpanel.btnCancelDraw,scale:"medium",iconCls:"myplaces_draw_cancel",handler:function(){e.module.closeWizard();e.mainPanel.sendStopDrawRequest()}});var b=Ext.create("Ext.panel.Panel",{border:false,frame:false,bodyPadding:5,layout:"fit",items:[g]});var f=Ext.create("Ext.Button",{text:this.oskariConfig.localizationSet.mainpanel.btnFinishDraw,scale:"medium",handler:function(){e.mainPanel.sendStopDrawRequest(true)}});c.uiItems.btnFinishDraw=f;var d=Ext.create("Ext.panel.Panel",{border:false,frame:false,bodyPadding:5,layout:"fit",items:[f]});c.items=[a,d,b]}});Ext.define("Oskari.mapframework.bundle.myplaces.ui.view.MyPlacesGrid",{extend:"Ext.grid.Panel",layout:"fit",category:null,service:null,places:null,placesHandler:null,module:null,initComponent:function(){if(!Ext.ClassManager.get("MyPlaceGridModel")){var b=["id","name","desc","type","createDate","updateDate"];Ext.define("MyPlaceGridModel",{extend:"Ext.data.Model",fields:b})}var c={};var a=Ext.create("Ext.data.Store",{model:"MyPlaceGridModel"});c.store=a;c.title=this.category.get("name");this._buildItems(c);Ext.apply(this,Ext.apply(this.initialConfig,c));this.callParent(arguments);if(this.places){this.populateGrid(this.places)}},_formatDate:function(a){var b=this.service.parseDate(a);var c="";if(b.length==0){return""}else{if(b.length>1){c=b[1]}}return b[0]+" "+c},updateGrid:function(b,c){var a=this;this.category=b;this.setTitle(b.get("name"));this.populateGrid(c)},populateGrid:function(f){var e=this;var a=[];for(var b=0;b<f.length;++b){var c=e.module.getDrawModeFromGeometry(f[b].get("geometry"));var d=Ext.create("MyPlaceGridModel",{id:f[b].get("id"),name:f[b].get("name"),description:f[b].get("description"),linkText:'<a href="#" onClick="return false;">'+e.localizationSet.grid.linkValue+"</a>",createDate:e._formatDate(f[b].get("createDate")),updateDate:e._formatDate(f[b].get("updateDate")),type:e.localizationSet.grid.type[c]});
a.push(d)}this.getStore().loadData(a)},getCategory:function(){return this.category},selectPlace:function(b){if(b){var a=null;this.getStore().findBy(function(c,e){var d=c.get("id");if(d==b.get("id")){a=c}});if(a){this.getSelectionModel().select([a]);this._placeSelected(a,false)}}},_placeSelected:function(b,a){var c=this.service.findMyPlace(b.get("id"));this.placesHandler.placeSelected(c,a)},_buildItems:function(a){var b=this;var c=[{header:this.localizationSet.grid.placeName,dataIndex:"name"},{header:this.localizationSet.grid.placeDesc,flex:1,dataIndex:"description"},{header:this.localizationSet.grid.type.label,dataIndex:"type"},{header:this.localizationSet.grid.linkHeader,width:120,dataIndex:"linkText"},{header:this.localizationSet.grid.createDate,width:120,dataIndex:"createDate"},{header:this.localizationSet.grid.updateDate,width:120,dataIndex:"updateDate"}];a.listeners={itemdblclick:function(g,d,h,f,i){b._placeSelected(d,true)},itemclick:function(g,d,h,f,i){b._placeSelected(d,false)},cellClick:function(h,e,g,d,f,k,j,i){b._cellClicked(h,e,g,d,f,k,j,i)}};a.columns=c},_cellClicked:function(f,b,j,e,c,h,a,g){var i=f.getGridColumns()[j].dataIndex;if(i==="linkText"){var d=this.service.findMyPlace(e.get("id"));this.placesHandler.moveMapTo(d)}}});Ext.define("Oskari.mapframework.bundle.myplaces.ui.view.MyPlacesGridPanel",{extend:"Ext.tab.Panel",layout:"fit",initComponent:function(){var a={};a.uiItems={};a.service=this.oskariConfig.service;a.title=this.oskariConfig.localizationSet.grid.title;Ext.apply(this,Ext.apply(this.initialConfig,a));this.callParent(arguments);this.customTooltip=Ext.create("Ext.tip.ToolTip",{autoHide:true})},placeSelected:function(c,a){var b=this.oskariConfig.sandbox.getEventBuilder("MyPlaces.MyPlaceSelectedEvent")(c,a);this.oskariConfig.sandbox.notifyAll(b)},moveMapTo:function(c){var a=c.get("geometry").getCentroid();var b=this.oskariConfig.sandbox.getRequestBuilder("MapMoveRequest")(a.x,a.y,c.get("geometry").getBounds(),false);this.oskariConfig.sandbox.request(this.oskariConfig.module.getName(),b)},showCategory:function(b){if(!b){this.setActiveTab(0);return this.getActiveTab()}else{var a=this.child("#myplaceCat_"+b);this.setActiveTab(a.tab);a.show();return a}},removeCategory:function(b){var a=this.child("#myplaceCat_"+b);if(a){this.remove(a.tab);a.destroy();a=null}},addOrUpdateCategory:function(d){var c=this;var e=d.get("id");var a=this.child("#myplaceCat_"+e);var f=this.service.getPlacesInCategory(e);if(a){a.updateGrid(d,f)}else{var b=Ext.create("Oskari.mapframework.bundle.myplaces.ui.view.MyPlacesGrid",{category:d,itemId:"myplaceCat_"+e,service:c.service,places:f,localizationSet:c.oskariConfig.localizationSet,placesHandler:c,module:c.oskariConfig.module});this.add(b)}},getSelectedCategory:function(){var a=this.getActiveTab();if(a){return a.getCategory()}return null},handleMapClick:function(d){var c=this.oskariConfig.sandbox.getMap().getZoom();var a=this.service.findMyPlaceByLonLat(d.getLonLat(),c);if(a.length>0){var b=this.showCategory(a[0].get("categoryID"));b.selectPlace(a[0])}},handleHover:function(d){var c=this.oskariConfig.sandbox.getMap().getZoom();var a=this.service.findMyPlaceByLonLat(d.getLonLat(),c);var f="";for(var b=0;b<a.length;++b){if(f){f=f+"<hr/>"}f=f+"<b>"+a[b].get("name")+"</b>";var e=a[b].get("description");if(e&&e.trim().length>0){f=f+"<br/>"+e}}if(f){this.customTooltip.update(f);this.customTooltip.show();this.customTooltip.setPagePosition(d.getHoverEvent().pageX,d.getHoverEvent().pageY)}else{this.customTooltip.hide()}}});Ext.define("Oskari.mapframework.bundle.myplaces.ui.view.MyPlacesMainPanel",{extend:"Ext.panel.Panel",layout:"fit",border:false,frame:false,initComponent:function(){var a={};a.uiItems={};a.category=null;a.title=this.oskariConfig.localizationSet.title;a.module=this.oskariConfig.module;this._buildItems(a);Ext.apply(this,Ext.apply(this.initialConfig,a));this.callParent(arguments)},startNewDrawing:function(a){var b=this.oskariConfig.sandbox.getEventBuilder("MyPlaces.MyPlaceSelectedEvent")();this.oskariConfig.sandbox.notifyAll(b);this.sendDrawRequest(a)},sendDrawRequest:function(a){var c=this;
var b=c.oskariConfig.sandbox.getRequestBuilder("MyPlaces.StartDrawingRequest")(a);c.oskariConfig.sandbox.request(c.oskariConfig.module.getName(),b);this.module.setDisableMapEvents(true);c.uiItems.basicControls.hide();if(!a.geometry){c.uiItems.drawControls.setDrawMode(a.drawMode,false);c.uiItems.drawControls.show()}c.oskariConfig.module.addLayerToMap()},sendStopDrawRequest:function(c){var b=this;var a=b.oskariConfig.sandbox.getRequestBuilder("MyPlaces.StopDrawingRequest")(c);b.oskariConfig.sandbox.request(b.oskariConfig.module.getName(),a);if(c!==true){this.module.setDisableMapEvents(false);b.uiItems.basicControls.show();b.uiItems.drawControls.hide()}},placeSelected:function(b){var a=this;a.uiItems.drawControls.hide();if(b){a.uiItems.basicControls.hide();a.uiItems.placeSelectedControls.show();a.uiItems.placeSelectedControls.placeSelected(b)}else{a.uiItems.placeSelectedControls.hide();a.uiItems.basicControls.show()}},_buildItems:function(c){var d=this;var b=Ext.create("Oskari.mapframework.bundle.myplaces.ui.view.MyPlacesBasicControls",{oskariConfig:{localizationSet:d.oskariConfig.localizationSet,mainPanel:d}});c.uiItems.basicControls=b;var a=Ext.create("Oskari.mapframework.bundle.myplaces.ui.view.MyPlacesDrawControls",{oskariConfig:{module:d.oskariConfig.module,localizationSet:d.oskariConfig.localizationSet,mainPanel:d},hidden:true});c.uiItems.drawControls=a;var f=Ext.create("Oskari.mapframework.bundle.myplaces.ui.view.MyPlacesPlaceSelectedControls",{oskariConfig:{module:d.oskariConfig.module,localizationSet:d.oskariConfig.localizationSet,mainPanel:d},hidden:true});c.uiItems.placeSelectedControls=f;var e=Ext.create("Ext.panel.Panel",{border:false,frame:false,autoScroll:true,layout:"anchor",bodyPadding:10,items:[b,a,f]});c.uiItems.mainPanel=e;c.items=[e]}});Ext.define("Oskari.mapframework.bundle.myplaces.ui.view.MyPlacesWizard",{extend:"Ext.window.Window",height:400,width:600,layout:"fit",closable:false,id:"myplaces-popup",initComponent:function(){var a={};a.uiItems={};a.uiItems.panels={};a.wizard={};a.service=this.oskariConfig.service;a.title=this.oskariConfig.localizationSet.wizard.title;var b=Ext.create("Ext.data.Store",{model:"Oskari.mapframework.bundle.myplaces.model.MyPlacesCategory",data:a.service.getAllCategories()});a.categoryStore=b;a.place={};this._buildItems(a);a.wizard.currentView=a.uiItems.panels.myPlacePanel;Ext.apply(this,Ext.apply(this.initialConfig,a));this.callParent(arguments)},_buildItems:function(a){var d=this;var c=Ext.create("Oskari.mapframework.bundle.myplaces.ui.view.CategoryPanel",{id:"myplace-popup-categorypanel",categoryStore:a.categoryStore,oskariConfig:{localizationSet:d.oskariConfig.localizationSet,defaults:d.oskariConfig.module.defaults},finishedAction:function(e){d._commitCategory(e)},deleteCategoryAction:function(e){d._confirmDeleteCategory(e)},cancelAction:function(){d._showMyPlaceForm()}});a.uiItems.panels.categoryPanel=c;var b=Ext.create("Oskari.mapframework.bundle.myplaces.ui.view.MyPlacePanel",{categoryStore:a.categoryStore,oskariConfig:{localizationSet:d.oskariConfig.localizationSet,service:d.oskariConfig.service},finishedAction:function(e,f){d._wizardFinished(e,f)},categoryOperation:function(e){d._showCategoryForm(e)}});a.uiItems.panels.myPlacePanel=b;a.items=[b]},_showCategoryForm:function(b){var a=this;a.uiItems.panels.myPlacePanel.saveValues();a.uiItems.panels.categoryPanel.setParams(b);a.wizard.currentView=a.uiItems.panels.categoryPanel;a._drawPanels()},_showMyPlaceForm:function(){var a=this;a.wizard.currentView=a.uiItems.panels.myPlacePanel;a.uiItems.panels.myPlacePanel.recreatePanel();a._drawPanels()},_confirmDeleteCategory:function(f){var e=this;var b=e.service.getDefaultCategory();var a=e.service.getPlacesInCategory(f.get("id"));var d=[{text:e.oskariConfig.localizationSet.confirm.btnCancel},"break"];var g=e.oskariConfig.localizationSet.confirm.btnDelete;var c=e.oskariConfig.module.formatMessage(e.oskariConfig.localizationSet.confirm.deleteConfirm,[f.get("name"),a.length]);if(a.length>0){c=c+"<br/><br/>"+e.oskariConfig.module.formatMessage(e.oskariConfig.localizationSet.confirm.deleteConfirmMoveText,[b.get("name")]);
d.push({text:e.oskariConfig.localizationSet.confirm.btnMove,handler:function(){e._deleteCategory(f,true)}});g=e.oskariConfig.localizationSet.confirm.btnDeleteAll}d.push({text:g,handler:function(){e._deleteCategory(f,false)}});Ext.create("Oskari.mapframework.bundle.myplaces.ui.view.ConfirmWindow",{title:e.oskariConfig.localizationSet.deleteConfirmTitle,message:c,dialogButtons:d}).show()},_deleteCategory:function(e,b){var d=this;var c=e.get("id");this.setLoading(d.oskariConfig.localizationSet.deletemask);var a=function(f){d._deleteCategoryCallback(f,b,c)};d.service.deleteCategory(c,b,a)},_deleteCategoryCallback:function(g,c,f){var e=this;this.setLoading(false);if(g){this.refreshCategories();if(c){this._showMyPlaceForm()}else{e.oskariConfig.module.cleanupAfterMyPlaceOperation()}if(c){var a=e.service.getDefaultCategory();var b=this.oskariConfig.module.getMapLayerId(a.get("id"));var d=this.oskariConfig.sandbox.getRequestBuilder("MapModulePlugin.MapLayerUpdateRequest")(b,true);this.oskariConfig.sandbox.request(this.oskariConfig.module.getName(),d)}}else{alert(this.oskariConfig.localizationSet.errorDelete)}},refreshCategories:function(){var a=this;a.uiItems.panels.myPlacePanel.setCategories(a.service.getAllCategories());a.uiItems.panels.myPlacePanel.setSelectedCategory()},_commitCategory:function(e){var d=this;this.setLoading(d.oskariConfig.localizationSet.savemask);var c=/\"/g;var b=e.get("name");e.set("name",b.replace(c,"'"));var a=function(h,g,f){d._commitCategoryCallback(h,g,f)};this.service.saveCategory(e,a)},_commitCategoryCallback:function(e,d,a){var c=this;this.setLoading(false);if(e){if(a){c.uiItems.panels.myPlacePanel.setCategories(c.service.getAllCategories());c.oskariConfig.module.addLayerToMap(d.get("id"))}else{var b=c.oskariConfig.sandbox.getRequestBuilder("MapModulePlugin.MapLayerUpdateRequest")(c.oskariConfig.module.getMapLayerId(d.get("id")),true);c.oskariConfig.sandbox.request(c.oskariConfig.module.getName(),b)}c.uiItems.panels.myPlacePanel.setSelectedCategory(d.get("id"));c._showMyPlaceForm()}else{alert(this.oskariConfig.localizationSet.errorSave)}},setPlace:function(a){this.uiItems.panels.myPlacePanel.setPlace(a);this.uiItems.panels.myPlacePanel.recreatePanel()},setSelectedCategory:function(a){this.uiItems.panels.myPlacePanel.setSelectedCategory(a)},_wizardFinished:function(c,e){var b=this;if(c){var d=function(f){c.set("geometry",f);b.oskariConfig.module.myPlaceFinished(c,e)};var a=b.oskariConfig.sandbox.getRequestBuilder("MyPlaces.GetGeometryRequest")(d);b.oskariConfig.sandbox.request(b.oskariConfig.module.getName(),a)}else{this.oskariConfig.module.myPlaceFinished(c)}},_drawPanels:function(){var a=this;a.removeAll(false);for(var b in a.uiItems.panels){a.uiItems.panels[b].hide()}a.add(a.wizard.currentView);a.wizard.currentView.show()}});Ext.define("Oskari.mapframework.bundle.myplaces.ui.view.MyPlacesPlaceSelectedControls",{extend:"Ext.panel.Panel",layout:"anchor",border:false,frame:false,title:"jee",closable:true,closeAction:"hide",initComponent:function(){var a={};a.uiItems={};a.module=this.oskariConfig.module;a.mainPanel=this.oskariConfig.mainPanel;this._buildItems(a);Ext.apply(this,Ext.apply(this.initialConfig,a));this.on("beforeclose",function(){this.module.cleanupAfterMyPlaceOperation()});this.callParent(arguments)},placeSelected:function(d){var b=this;if(d){var a={};a.geometry=d.get("geometry").clone();var c=this.oskariConfig.module.getDrawModeFromGeometry(a.geometry);a.drawMode=this.oskariConfig.module.getDrawModeFromGeometry(a.geometry);this.mainPanel.sendDrawRequest(a);this.setTitle(d.get("name"));this.uiItems.btnSave.setText(this.oskariConfig.localizationSet.mainpanel.editSaveBtn[a.drawMode]);this.uiItems.editHelp.update(this.oskariConfig.localizationSet.mainpanel.editHelp[a.drawMode]);this.uiItems.btnEdit.setTooltip(this.oskariConfig.localizationSet.mainpanel.btnEdit+": "+d.get("name"));this.uiItems.btnDelete.selectedPlace=d;this.uiItems.btnDelete.setTooltip(this.oskariConfig.localizationSet.mainpanel.btnDelete+": "+d.get("name"))}else{this.uiItems.btnDelete.selectedPlace=null}},_buildItems:function(b){var i=this;
var j=Ext.create("Ext.form.Label",{text:this.oskariConfig.localizationSet.mainpanel.editHelp.point});b.uiItems.editHelp=j;var c=Ext.create("Ext.Button",{text:this.oskariConfig.localizationSet.saveBtn,tooltip:this.oskariConfig.localizationSet.saveBtn,scale:"medium",handler:function(){i.oskariConfig.module.saveMyPlaceGeometry()}});var k=Ext.create("Ext.panel.Panel",{border:false,frame:false,bodyPadding:5,layout:"fit",items:[c]});b.uiItems.btnSave=c;var g=Ext.create("Ext.form.Label",{text:this.oskariConfig.localizationSet.mainpanel.editHelp.desc});var f=Ext.create("Ext.Button",{text:this.oskariConfig.localizationSet.mainpanel.btnEdit,tooltip:this.oskariConfig.localizationSet.mainpanel.btnEdit,scale:"medium",iconCls:"myplaces_edit_place",handler:function(){b.module.startWizard()}});var a=Ext.create("Ext.panel.Panel",{border:false,frame:false,bodyPadding:5,layout:"fit",items:[f]});b.uiItems.btnEdit=f;var h=Ext.create("Ext.form.Label",{text:this.oskariConfig.localizationSet.mainpanel.deleteHelp});var e=Ext.create("Ext.Button",{scale:"medium",tooltip:this.oskariConfig.localizationSet.mainpanel.btnDelete,iconCls:"myplaces_delete_place",text:this.oskariConfig.localizationSet.mainpanel.btnDelete,selectedPlace:null,handler:function(){Ext.Msg.show({title:i.oskariConfig.localizationSet.deleteConfirmTitle,modal:true,msg:i.oskariConfig.localizationSet.mainpanel.deleteConfirm+this.selectedPlace.get("name"),buttons:Ext.Msg.OKCANCEL,icon:Ext.MessageBox.QUESTION,fn:function(l){if(l==="ok"){i.oskariConfig.module.deleteMyPlace()}}})}});var d=Ext.create("Ext.panel.Panel",{border:false,frame:false,bodyPadding:5,layout:"fit",items:[e]});b.uiItems.btnDelete=e;b.items=[j,k,g,a,h,d]}});Oskari.clazz.define("Oskari.mapframework.bundle.MyPlacesBundleInstance",function(a){this.name="myplaces";this.mediator=null;this.sandbox=null;this.impl=null;this.ui=null},{start:function(){if(this.mediator.getState()=="started"){return}this.libs={ext:Oskari.$("Ext")};this.facade=Oskari.$("UI.facade");this.impl=Oskari.clazz.create("Oskari.mapframework.ui.module.myplaces.MyPlacesModule",this.conf);var a=this.facade.appendExtensionModule(this.impl,this.name,{},this,"E",{fi:{title:"Omat Paikat"},sv:{title:"?"},en:{title:"My Places"}});this.def=a;this.impl.start(this.facade.getSandbox());this.mediator.setState("started");return this},update:function(d,a,c,e){d.alert("RECEIVED update notification @BUNDLE_INSTANCE: "+e)},stop:function(){this.impl.stop();this.facade.removeExtensionModule(this.impl,this.name,this.impl.eventHandlers,this,this.def);this.def=null;this.impl=null;this.mediator.setState("stopped");return this},getName:function(){return this.__name},__name:"Oskari.mapframework.bundle.MyPlacesBundleInstance"},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.bundle.extension.Extension"]});